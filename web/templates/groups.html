<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Analysis — Stock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    ink: '#37352f',
                    muted: '#9b9a97',
                    subtle: '#6b6b6b',
                    lite: '#c4c3bf',
                    edge: '#e3e2de',
                    surface: '#fbfbfa',
                    tint: '#f7f6f3',
                    wash: '#f0efec',
                    bull: '#0f7b3f',
                    bear: '#c4314b',
                    'bull-bg': '#dbf3e6',
                    'bear-bg': '#fce4e8',
                    neutral: '#787774',
                },
                fontFamily: {
                    sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Noto Sans', 'Helvetica', 'Arial', 'sans-serif'],
                },
            }
        }
    }
    </script>
    <style>
        /* Sort arrow pseudo-elements */
        .results-table th.sort-asc::after { content: ' \2191'; }
        .results-table th.sort-desc::after { content: ' \2193'; }

        /* Animations */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* JS-toggled states */
        .progress-container { display: none; }
        .progress-container.active { display: block; }
        .results-container { display: none; }
        .results-container.active { display: block; animation: fadeSlideIn 0.4s ease-out; }
        .stock-editor { display: none; }
        .stock-editor.active { display: block; animation: fadeSlideIn 0.3s ease-out; }
        .add-autocomplete-list { display: none; }
        .add-autocomplete-list.visible { display: block; }
        .error-message { animation: fadeSlideIn 0.3s ease-out; }
    </style>
</head>
<body class="font-sans bg-white text-ink leading-relaxed antialiased">
    <div class="max-w-[1100px] mx-auto px-3 py-6 sm:px-5 sm:py-8 lg:px-10 lg:py-[60px]">
        <!-- Header -->
        <div class="mb-6 lg:mb-12">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <h1 class="text-[22px] sm:text-[28px] lg:text-[40px] font-bold -tracking-[0.03em] text-ink mb-1 sm:mb-2">Group Analysis</h1>
                    <p class="text-sm lg:text-base text-muted">Magic Formula ranking across stock indices</p>
                    <p class="text-xs text-lite mt-1" id="todayDate"></p>
                </div>
                <div class="flex gap-4">
                    <a href="/" class="text-[13px] text-muted no-underline transition-colors hover:text-ink">← Dashboard</a>
                    <a href="/analyze" class="text-[13px] text-muted no-underline transition-colors hover:text-ink">Individual Analysis →</a>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="mb-8">
            <!-- Market toggle -->
            <div class="inline-flex bg-wash rounded-md p-0.5 mb-3" id="marketToggle">
                <button class="active font-sans text-[13px] font-medium px-4 py-1.5 border-none rounded bg-white text-ink shadow-sm cursor-pointer transition-all duration-150" data-market="IN">India</button>
                <button class="font-sans text-[13px] font-medium px-4 py-1.5 border-none rounded bg-transparent text-muted cursor-pointer transition-all duration-150 hover:text-subtle" data-market="US">US</button>
            </div>

            <!-- Group selector -->
            <div class="flex flex-col sm:flex-row sm:flex-wrap gap-3 mb-6" id="groupSelector"></div>

            <!-- Stock editor -->
            <div class="stock-editor mb-6 p-4 sm:p-5 border border-edge rounded-lg bg-surface" id="stockEditor">
                <div class="flex items-center justify-between mb-3">
                    <strong class="text-sm font-semibold text-ink">Stocks</strong>
                    <span class="text-[13px] text-muted" id="stockCount"></span>
                </div>
                <div class="flex flex-wrap gap-1.5 mb-3 max-h-[200px] overflow-y-auto" id="stockChips"></div>
                <div class="flex gap-2 relative">
                    <input type="text" id="addStockInput" placeholder="e.g. RELIANCE" autocomplete="off" spellcheck="false"
                        class="font-sans text-[13px] px-3 py-1.5 border border-edge rounded outline-none flex-1 sm:flex-none sm:w-40 uppercase focus:border-ink min-w-0">
                    <button id="addStockBtn" class="font-sans text-[13px] font-medium px-3.5 py-1.5 border border-edge rounded bg-white text-ink cursor-pointer transition-all duration-150 hover:border-ink hover:bg-wash">Add</button>
                    <div class="add-autocomplete-list absolute top-full left-0 w-full sm:w-80 bg-white border border-edge border-t-0 rounded-b-lg shadow-lg z-50 max-h-60 overflow-y-auto" id="addAutocompleteList"></div>
                </div>
            </div>

            <!-- Run button -->
            <button class="font-sans text-sm font-semibold px-7 py-2.5 border-none rounded-md bg-ink text-white cursor-pointer transition-all duration-150 w-full sm:w-auto hover:bg-[#1a1a1a] disabled:bg-lite disabled:cursor-not-allowed" id="runBtn" disabled>Run Magic Formula</button>
        </div>

        <!-- Progress -->
        <div class="progress-container mb-8" id="progressContainer">
            <div class="text-sm text-subtle mb-2" id="progressText">Analyzing stocks...</div>
            <div class="w-full h-1.5 bg-wash rounded overflow-hidden">
                <div class="h-full bg-ink rounded transition-[width] duration-300 ease-out w-0" id="progressFill"></div>
            </div>
            <div class="text-xs text-muted mt-1.5" id="progressSkipped"></div>
        </div>

        <!-- Results -->
        <div class="results-container" id="resultsContainer">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 mb-5">
                <h2 class="text-xl sm:text-2xl font-bold -tracking-[0.02em]" id="resultsTitle">Rankings</h2>
                <span class="text-[13px] text-muted" id="resultsCount"></span>
            </div>
            <div class="overflow-x-auto border border-edge rounded-lg">
                <table class="results-table w-full border-collapse text-xs sm:text-[13px]" id="resultsTable">
                    <thead>
                        <tr>
                            <th class="sort-asc px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="rank">Rank</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="symbol">Symbol</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="name">Name</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="earnings_yield">EY %</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="roic">ROIC %</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="ey_rank">EY Rank</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="roic_rank">ROIC Rank</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="combined_score">Score</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="price">Price</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="pe">PE</th>
                            <th class="px-2.5 sm:px-4 py-2.5 sm:py-3 text-left font-semibold text-[10px] sm:text-[11px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="market_cap">Mkt Cap</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // Cache helpers
        const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

        function getCache(key) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                if (Date.now() - obj.ts > CACHE_TTL_MS) {
                    localStorage.removeItem(key);
                    return null;
                }
                return obj.rankings;
            } catch (_) { return null; }
        }

        function setCache(key, rankings) {
            try {
                localStorage.setItem(key, JSON.stringify({ rankings, ts: Date.now() }));
            } catch (_) {}
        }

        const marketToggle = document.getElementById('marketToggle');
        const groupSelector = document.getElementById('groupSelector');
        const stockEditor = document.getElementById('stockEditor');
        const stockChips = document.getElementById('stockChips');
        const stockCount = document.getElementById('stockCount');
        const addStockInput = document.getElementById('addStockInput');
        const addStockBtn = document.getElementById('addStockBtn');
        const runBtn = document.getElementById('runBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const progressSkipped = document.getElementById('progressSkipped');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsCount = document.getElementById('resultsCount');
        const resultsBody = document.getElementById('resultsBody');
        const resultsTable = document.getElementById('resultsTable');

        let selectedMarket = 'IN';
        let selectedGroup = null;
        let editableSymbols = [];
        let currentSource = null;
        let rankings = [];
        let currentSortKey = 'rank';
        let currentSortDir = 'asc';

        // Market toggle
        marketToggle.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-market]');
            if (!btn || btn.classList.contains('active')) return;
            marketToggle.querySelectorAll('button').forEach(b => {
                b.classList.remove('active', 'bg-white', 'text-ink', 'shadow-sm');
                b.classList.add('bg-transparent', 'text-muted');
            });
            btn.classList.add('active', 'bg-white', 'text-ink', 'shadow-sm');
            btn.classList.remove('bg-transparent', 'text-muted');
            selectedMarket = btn.dataset.market;
            selectedGroup = null;
            editableSymbols = [];
            stockEditor.classList.remove('active');
            loadGroups();
        });

        // Load groups for selected market
        async function loadGroups() {
            runBtn.disabled = true;
            resultsContainer.classList.remove('active');
            progressContainer.classList.remove('active');

            try {
                const res = await fetch(`/api/groups?market=${selectedMarket}`);
                const groups = await res.json();
                renderGroups(groups);
            } catch (err) {
                groupSelector.innerHTML = '<div class="text-center py-12 px-5 text-muted text-[15px]">Failed to load groups</div>';
            }
        }

        function renderGroups(groups) {
            groupSelector.innerHTML = groups.map(g => `
                <div class="group-card px-4 sm:px-6 py-3 sm:py-3.5 border border-edge rounded-lg cursor-pointer transition-all duration-150 bg-white hover:border-ink" data-id="${escapeHtml(g.id)}">
                    <div class="font-semibold text-sm sm:text-[15px] text-ink">${escapeHtml(g.name)}</div>
                    <div class="text-xs text-muted mt-0.5">${g.count} stocks</div>
                </div>
            `).join('');

            groupSelector.querySelectorAll('.group-card').forEach(card => {
                card.addEventListener('click', async () => {
                    groupSelector.querySelectorAll('.group-card').forEach(c => {
                        c.classList.remove('border-ink', 'bg-surface', 'shadow-[0_0_0_1px_#37352f]');
                    });
                    card.classList.add('border-ink', 'bg-surface', 'shadow-[0_0_0_1px_#37352f]');
                    selectedGroup = card.dataset.id;

                    try {
                        const res = await fetch(`/api/groups/${encodeURIComponent(selectedGroup)}/symbols?market=${selectedMarket}`);
                        const data = await res.json();
                        editableSymbols = [...data.symbols];
                        renderStockChips();
                        stockEditor.classList.add('active');
                        runBtn.disabled = false;
                    } catch (err) {
                        stockEditor.classList.remove('active');
                    }
                });
            });
        }

        // Stock editor
        function renderStockChips() {
            stockChips.innerHTML = editableSymbols.map(s => `
                <span class="inline-flex items-center gap-1 px-2.5 py-1 bg-white border border-edge rounded text-xs font-medium text-ink">
                    ${escapeHtml(s)}
                    <span class="remove-chip cursor-pointer text-muted text-sm leading-none ml-0.5 transition-colors hover:text-bear" data-symbol="${escapeHtml(s)}">&times;</span>
                </span>
            `).join('');
            stockCount.textContent = `${editableSymbols.length} stocks`;
            runBtn.disabled = editableSymbols.length === 0;

            stockChips.querySelectorAll('.remove-chip').forEach(btn => {
                btn.addEventListener('click', () => {
                    editableSymbols = editableSymbols.filter(s => s !== btn.dataset.symbol);
                    renderStockChips();
                });
            });
        }

        addStockBtn.addEventListener('click', addStock);

        // Autocomplete for add-stock input
        const addAutocompleteList = document.getElementById('addAutocompleteList');
        let addSearchTimeout = null;
        let addSuggestions = [];
        let addActiveIndex = -1;

        addStockInput.addEventListener('input', () => {
            const query = addStockInput.value.trim();
            clearTimeout(addSearchTimeout);
            if (query.length < 1) {
                hideAddAutocomplete();
                return;
            }
            addSearchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&market=${selectedMarket}`);
                    addSuggestions = await res.json();
                    addActiveIndex = -1;
                    renderAddAutocomplete(addSuggestions);
                } catch (_) {
                    hideAddAutocomplete();
                }
            }, 100);
        });

        addStockInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (addSuggestions.length > 0) {
                    addActiveIndex = Math.min(addActiveIndex + 1, addSuggestions.length - 1);
                    highlightAddItem();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (addSuggestions.length > 0) {
                    addActiveIndex = Math.max(addActiveIndex - 1, 0);
                    highlightAddItem();
                }
            } else if (e.key === 'Enter') {
                if (addActiveIndex >= 0 && addSuggestions[addActiveIndex]) {
                    addStockInput.value = addSuggestions[addActiveIndex].symbol;
                }
                hideAddAutocomplete();
                addStock();
            } else if (e.key === 'Escape') {
                hideAddAutocomplete();
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative') && !e.target.closest('.stock-editor')) {
                hideAddAutocomplete();
            }
        });

        function renderAddAutocomplete(items) {
            if (items.length === 0) {
                hideAddAutocomplete();
                return;
            }
            addAutocompleteList.innerHTML = items.map((item, i) => `
                <div class="px-3 py-2 cursor-pointer flex items-center gap-2.5 transition-colors text-[13px] hover:bg-tint ${i === addActiveIndex ? 'bg-tint' : ''} ${i === items.length - 1 ? 'rounded-b-lg' : ''}" data-index="${i}">
                    <span class="font-semibold text-ink min-w-[80px]">${escapeHtml(item.symbol)}</span>
                    <span class="text-muted whitespace-nowrap overflow-hidden text-ellipsis">${escapeHtml(item.name)}</span>
                </div>
            `).join('');

            addAutocompleteList.querySelectorAll('[data-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = parseInt(el.dataset.index);
                    addStockInput.value = addSuggestions[idx].symbol;
                    hideAddAutocomplete();
                    addStock();
                });
            });

            addAutocompleteList.classList.add('visible');
        }

        function highlightAddItem() {
            addAutocompleteList.querySelectorAll('[data-index]').forEach((el, i) => {
                el.classList.toggle('bg-tint', i === addActiveIndex);
            });
        }

        function hideAddAutocomplete() {
            addAutocompleteList.classList.remove('visible');
            addSuggestions = [];
            addActiveIndex = -1;
        }

        function addStock() {
            const val = addStockInput.value.trim().toUpperCase();
            if (!val) return;
            if (editableSymbols.includes(val)) {
                addStockInput.value = '';
                return;
            }
            editableSymbols.push(val);
            addStockInput.value = '';
            renderStockChips();
        }

        // Run analysis
        runBtn.addEventListener('click', () => {
            if (editableSymbols.length === 0) return;
            startAnalysis();
        });

        async function startAnalysis() {
            if (currentSource) currentSource.close();

            const cacheKey = `mf_custom_${selectedMarket}_${[...editableSymbols].sort().join(',')}`;
            const cached = getCache(cacheKey);

            if (cached) {
                rankings = cached;
                resultsBody.innerHTML = '';
                renderResults();
                return;
            }

            // Reset UI
            resultsContainer.classList.remove('active');
            progressContainer.classList.add('active');
            progressFill.style.width = '0%';
            progressText.textContent = 'Starting analysis...';
            progressSkipped.textContent = '';
            resultsBody.innerHTML = '';
            runBtn.disabled = true;

            let skipped = 0;

            try {
                const response = await fetch('/api/magic-formula', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: editableSymbols, market: selectedMarket }),
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    let currentEvent = null;
                    for (const line of lines) {
                        if (line.startsWith('event:')) {
                            currentEvent = line.slice(6).trim();
                        } else if (line.startsWith('data:') && currentEvent) {
                            const dataStr = line.slice(5).trim();
                            try {
                                const data = JSON.parse(dataStr);
                                if (currentEvent === 'progress') {
                                    const pct = Math.round((data.current / data.total) * 100);
                                    progressFill.style.width = `${pct}%`;
                                    progressText.textContent = `Analyzing ${data.symbol} (${data.current}/${data.total})`;
                                    if (data.status === 'skipped') {
                                        skipped++;
                                        progressSkipped.textContent = `${skipped} stock${skipped > 1 ? 's' : ''} skipped (insufficient data)`;
                                    }
                                } else if (currentEvent === 'result') {
                                    rankings = data.rankings;
                                    renderResults();
                                    setCache(cacheKey, data.rankings);
                                } else if (currentEvent === 'error') {
                                    showError(data.message);
                                } else if (currentEvent === 'done') {
                                    // done
                                }
                            } catch (_) {}
                            currentEvent = null;
                        }
                    }
                }
            } catch (err) {
                showError('Analysis failed: ' + err.message);
            }

            progressContainer.classList.remove('active');
            runBtn.disabled = false;
        }

        function renderResults() {
            if (rankings.length === 0) {
                resultsContainer.classList.add('active');
                resultsBody.innerHTML = '<tr><td colspan="11" class="text-center py-12 px-5 text-muted text-[15px]">No stocks with sufficient data</td></tr>';
                return;
            }

            const selectedCard = groupSelector.querySelector('.group-card.border-ink .font-semibold');
            const groupName = selectedCard ? selectedCard.textContent : 'Group';
            resultsTitle.textContent = `${groupName} — Magic Formula`;
            resultsCount.textContent = `${rankings.length} stocks ranked`;

            fillTable(rankings);
            resultsContainer.classList.add('active');
        }

        function fillTable(data) {
            resultsBody.innerHTML = data.map((s, i) => {
                const isTop = s.rank <= 5;
                return `<tr class="hover:bg-surface">
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap font-bold text-ink text-center w-[50px] ${isTop ? 'text-bull' : ''}">${s.rank}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap font-semibold text-ink"><a href="/analyze?symbol=${encodeURIComponent(s.symbol)}&market=${selectedMarket}" target="_blank" class="text-inherit no-underline border-b border-dashed border-lite transition-colors hover:border-ink">${escapeHtml(s.symbol)}</a></td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-subtle max-w-[100px] sm:max-w-[200px] overflow-hidden text-ellipsis" title="${escapeHtml(s.name)}">${escapeHtml(s.name)}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums ${s.earnings_yield > 0 ? 'text-bull' : 'text-bear'}">${s.earnings_yield.toFixed(2)}%</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums ${s.roic > 0 ? 'text-bull' : 'text-bear'}">${s.roic.toFixed(2)}%</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.ey_rank}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.roic_rank}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums font-semibold">${s.combined_score}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.price != null ? s.price.toFixed(2) : 'N/A'}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.pe != null ? s.pe.toFixed(1) : 'N/A'}</td>
                    <td class="px-2.5 sm:px-4 py-2 sm:py-2.5 border-b border-wash whitespace-nowrap text-right tabular-nums">${escapeHtml(s.market_cap)}</td>
                </tr>`;
            }).join('');
        }

        // Sortable columns
        resultsTable.querySelectorAll('th[data-key]').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (currentSortKey === key) {
                    currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortKey = key;
                    currentSortDir = 'asc';
                }

                resultsTable.querySelectorAll('th').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                th.classList.add(currentSortDir === 'asc' ? 'sort-asc' : 'sort-desc');

                const sorted = [...rankings].sort((a, b) => {
                    let va = a[key], vb = b[key];
                    if (typeof va === 'string') {
                        va = va.toLowerCase();
                        vb = (vb || '').toLowerCase();
                        return currentSortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                    }
                    va = va ?? Infinity;
                    vb = vb ?? Infinity;
                    return currentSortDir === 'asc' ? va - vb : vb - va;
                });
                fillTable(sorted);
            });
        });

        function showError(message) {
            const el = document.createElement('div');
            el.className = 'error-message px-4 sm:px-5 py-3 sm:py-4 bg-bear-bg text-bear rounded-lg text-sm mb-4';
            el.textContent = message;
            progressContainer.insertAdjacentElement('afterend', el);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Init
        loadGroups();
    </script>
</body>
</html>
