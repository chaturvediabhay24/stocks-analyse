<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    ink: '#37352f',
                    muted: '#9b9a97',
                    subtle: '#6b6b6b',
                    lite: '#c4c3bf',
                    edge: '#e3e2de',
                    surface: '#fbfbfa',
                    tint: '#f7f6f3',
                    wash: '#f0efec',
                    bull: '#0f7b3f',
                    bear: '#c4314b',
                    'bull-bg': '#dbf3e6',
                    'bear-bg': '#fce4e8',
                },
                fontFamily: {
                    sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Noto Sans', 'Helvetica', 'Arial', 'sans-serif'],
                },
            }
        }
    }
    </script>
    <style>
        /* Sort arrow pseudo-elements */
        .results-table th.sort-asc::after { content: ' \2191'; }
        .results-table th.sort-desc::after { content: ' \2193'; }

        /* Animation */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .results-table-wrapper.loaded { animation: fadeSlideIn 0.4s ease-out; }

        /* JS-toggled states */
        .panel-progress { display: none; }
        .panel-progress.active { display: block; }

        /* Mobile panel toggle (below lg) */
        @media (max-width: 1023px) {
            .table-panel { display: none; }
            .table-panel.mobile-visible { display: block; }
        }
    </style>
</head>
<body class="font-sans bg-white text-ink leading-relaxed antialiased">
    <div class="max-w-[1200px] mx-auto px-3 py-6 sm:px-5 sm:py-8 lg:px-10 lg:py-[60px]">
        <!-- Header -->
        <div class="mb-6 lg:mb-12">
            <h1 class="text-[22px] sm:text-[28px] lg:text-[40px] font-bold -tracking-[0.03em] text-ink mb-2">Stock Analyzer</h1>
            <p class="text-sm lg:text-base text-muted">Magic Formula rankings at a glance</p>
            <p class="text-xs text-lite mt-1" id="todayDate"></p>
        </div>

        <!-- Nav -->
        <div class="flex gap-1.5 sm:gap-2 mb-6 lg:mb-10">
            <a href="/" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-ink rounded-md bg-ink text-white no-underline transition-all duration-150">Dashboard</a>
            <a href="/groups" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-edge rounded-md bg-white text-subtle no-underline transition-all duration-150 hover:border-ink hover:text-ink">Group Analysis</a>
            <a href="/analyze" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-edge rounded-md bg-white text-subtle no-underline transition-all duration-150 hover:border-ink hover:text-ink">Individual Analysis</a>
        </div>

        <!-- Mobile tab toggle (hidden on desktop) -->
        <div class="flex lg:hidden bg-wash rounded-md p-0.5 mb-5" id="mobileTabToggle">
            <button class="flex-1 text-[13px] font-medium py-2 border-none rounded bg-white text-ink shadow-sm cursor-pointer transition-all duration-150 active" data-panel="IN">Nifty 50 (India)</button>
            <button class="flex-1 text-[13px] font-medium py-2 border-none rounded bg-transparent text-muted cursor-pointer transition-all duration-150" data-panel="US">NASDAQ 100 (US)</button>
        </div>

        <!-- Tables grid -->
        <div class="lg:grid lg:grid-cols-2 lg:gap-10">
            <!-- India: Nifty 50 -->
            <div class="table-panel mobile-visible min-w-0" id="panelIN">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-[17px] sm:text-lg lg:text-xl font-bold -tracking-[0.02em]">Nifty 50</h2>
                    <span class="text-[13px] text-muted font-medium">India (NSE)</span>
                </div>
                <div class="panel-progress active mb-4" id="progressIN">
                    <div class="text-[13px] text-muted mb-1.5" id="progressTextIN">Loading...</div>
                    <div class="w-full h-1 bg-wash rounded-sm overflow-hidden">
                        <div class="h-full bg-ink rounded-sm transition-[width] duration-300 ease-out w-0" id="progressFillIN"></div>
                    </div>
                </div>
                <div class="results-table-wrapper overflow-x-auto border border-edge rounded-lg" id="tableWrapperIN">
                    <table class="results-table w-full border-collapse text-[11px] sm:text-xs" id="tableIN">
                        <thead>
                            <tr>
                                <th class="sort-asc px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="rank">Rank</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="symbol">Symbol</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="name">Name</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="earnings_yield">EY %</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="roic">ROIC %</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="combined_score">Score</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="price">Price</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="pe">PE</th>
                            </tr>
                        </thead>
                        <tbody id="bodyIN"></tbody>
                    </table>
                </div>
            </div>

            <!-- US: NASDAQ 100 -->
            <div class="table-panel min-w-0" id="panelUS">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-[17px] sm:text-lg lg:text-xl font-bold -tracking-[0.02em]">NASDAQ 100</h2>
                    <span class="text-[13px] text-muted font-medium">US</span>
                </div>
                <div class="panel-progress active mb-4" id="progressUS">
                    <div class="text-[13px] text-muted mb-1.5" id="progressTextUS">Loading...</div>
                    <div class="w-full h-1 bg-wash rounded-sm overflow-hidden">
                        <div class="h-full bg-ink rounded-sm transition-[width] duration-300 ease-out w-0" id="progressFillUS"></div>
                    </div>
                </div>
                <div class="results-table-wrapper overflow-x-auto border border-edge rounded-lg" id="tableWrapperUS">
                    <table class="results-table w-full border-collapse text-[11px] sm:text-xs" id="tableUS">
                        <thead>
                            <tr>
                                <th class="sort-asc px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="rank">Rank</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="symbol">Symbol</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="name">Name</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="earnings_yield">EY %</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="roic">ROIC %</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="combined_score">Score</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="price">Price</th>
                                <th class="px-2 sm:px-3 py-2 text-left font-semibold text-[9px] sm:text-[10px] uppercase tracking-[0.08em] text-muted bg-surface border-b border-edge cursor-pointer select-none whitespace-nowrap hover:text-ink" data-key="pe">PE</th>
                            </tr>
                        </thead>
                        <tbody id="bodyUS"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // Cache helpers
        const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

        function getCache(key) {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                if (Date.now() - obj.ts > CACHE_TTL_MS) {
                    localStorage.removeItem(key);
                    return null;
                }
                return obj.rankings;
            } catch (_) { return null; }
        }

        function setCache(key, rankings) {
            try {
                localStorage.setItem(key, JSON.stringify({ rankings, ts: Date.now() }));
            } catch (_) {}
        }

        // Panel config
        const panels = {
            IN: {
                groupId: 'nifty50',
                market: 'IN',
                progress: document.getElementById('progressIN'),
                progressText: document.getElementById('progressTextIN'),
                progressFill: document.getElementById('progressFillIN'),
                tableWrapper: document.getElementById('tableWrapperIN'),
                table: document.getElementById('tableIN'),
                body: document.getElementById('bodyIN'),
                rankings: [],
                sortKey: 'rank',
                sortDir: 'asc',
            },
            US: {
                groupId: 'nasdaq100',
                market: 'US',
                progress: document.getElementById('progressUS'),
                progressText: document.getElementById('progressTextUS'),
                progressFill: document.getElementById('progressFillUS'),
                tableWrapper: document.getElementById('tableWrapperUS'),
                table: document.getElementById('tableUS'),
                body: document.getElementById('bodyUS'),
                rankings: [],
                sortKey: 'rank',
                sortDir: 'asc',
            },
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function fillTable(panel, data) {
            panel.body.innerHTML = data.map(s => {
                const isTop = s.rank <= 5;
                return `<tr class="hover:bg-surface">
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap font-bold text-ink text-center w-10 ${isTop ? 'text-bull' : ''}">${s.rank}</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap font-semibold text-ink"><a href="/analyze?symbol=${encodeURIComponent(s.symbol)}&market=${panel.market}" target="_blank" class="text-inherit no-underline border-b border-dashed border-lite transition-colors hover:border-ink">${escapeHtml(s.symbol)}</a></td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-subtle max-w-[90px] sm:max-w-[150px] overflow-hidden text-ellipsis" title="${escapeHtml(s.name)}">${escapeHtml(s.name)}</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-right tabular-nums ${s.earnings_yield > 0 ? 'text-bull' : 'text-bear'}">${s.earnings_yield.toFixed(2)}%</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-right tabular-nums ${s.roic > 0 ? 'text-bull' : 'text-bear'}">${s.roic.toFixed(2)}%</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-right tabular-nums font-semibold">${s.combined_score}</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.price != null ? s.price.toFixed(2) : 'N/A'}</td>
                    <td class="px-2 sm:px-3 py-1.5 sm:py-2 border-b border-wash whitespace-nowrap text-right tabular-nums">${s.pe != null ? s.pe.toFixed(1) : 'N/A'}</td>
                </tr>`;
            }).join('');
        }

        function setupSorting(panel) {
            panel.table.querySelectorAll('th[data-key]').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    if (panel.sortKey === key) {
                        panel.sortDir = panel.sortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        panel.sortKey = key;
                        panel.sortDir = 'asc';
                    }
                    panel.table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                    th.classList.add(panel.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');

                    const sorted = [...panel.rankings].sort((a, b) => {
                        let va = a[key], vb = b[key];
                        if (typeof va === 'string') {
                            va = va.toLowerCase();
                            vb = (vb || '').toLowerCase();
                            return panel.sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                        }
                        va = va ?? Infinity;
                        vb = vb ?? Infinity;
                        return panel.sortDir === 'asc' ? va - vb : vb - va;
                    });
                    fillTable(panel, sorted);
                });
            });
        }

        async function loadPanel(panel) {
            const cacheKey = `mf_${panel.groupId}_${panel.market}`;
            const cached = getCache(cacheKey);

            if (cached) {
                panel.rankings = cached;
                fillTable(panel, panel.rankings);
                panel.tableWrapper.classList.add('loaded');
                panel.progress.classList.remove('active');
                return;
            }

            try {
                const response = await fetch(`/api/groups/${panel.groupId}/magic-formula?market=${panel.market}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    let currentEvent = null;
                    for (const line of lines) {
                        if (line.startsWith('event:')) {
                            currentEvent = line.slice(6).trim();
                        } else if (line.startsWith('data:') && currentEvent) {
                            const dataStr = line.slice(5).trim();
                            try {
                                const data = JSON.parse(dataStr);
                                if (currentEvent === 'progress') {
                                    const pct = Math.round((data.current / data.total) * 100);
                                    panel.progressFill.style.width = `${pct}%`;
                                    panel.progressText.textContent = `Analyzing ${data.symbol} (${data.current}/${data.total})`;
                                } else if (currentEvent === 'result') {
                                    panel.rankings = data.rankings;
                                    fillTable(panel, panel.rankings);
                                    panel.tableWrapper.classList.add('loaded');
                                    setCache(cacheKey, data.rankings);
                                } else if (currentEvent === 'error') {
                                    panel.body.innerHTML = `<tr><td colspan="8" class="text-center py-12 px-5 text-muted text-sm">${escapeHtml(data.message)}</td></tr>`;
                                }
                            } catch (_) {}
                            currentEvent = null;
                        }
                    }
                }
            } catch (err) {
                panel.body.innerHTML = `<tr><td colspan="8" class="text-center py-12 px-5 text-muted text-sm">Failed to load</td></tr>`;
            }

            panel.progress.classList.remove('active');
        }

        // Mobile tab toggle
        document.getElementById('mobileTabToggle').addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-panel]');
            if (!btn || btn.classList.contains('active')) return;
            // Update button styles
            document.querySelectorAll('#mobileTabToggle button').forEach(b => {
                b.classList.remove('active', 'bg-white', 'text-ink', 'shadow-sm');
                b.classList.add('bg-transparent', 'text-muted');
            });
            btn.classList.add('active', 'bg-white', 'text-ink', 'shadow-sm');
            btn.classList.remove('bg-transparent', 'text-muted');
            // Toggle panels
            document.querySelectorAll('.table-panel').forEach(p => p.classList.remove('mobile-visible'));
            document.getElementById('panel' + btn.dataset.panel).classList.add('mobile-visible');
        });

        // Init: load both panels in parallel
        setupSorting(panels.IN);
        setupSorting(panels.US);
        loadPanel(panels.IN);
        loadPanel(panels.US);
    </script>
</body>
</html>
