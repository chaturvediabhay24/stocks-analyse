<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    ink: '#37352f',
                    muted: '#9b9a97',
                    subtle: '#6b6b6b',
                    lite: '#c4c3bf',
                    edge: '#e3e2de',
                    surface: '#fbfbfa',
                    tint: '#f7f6f3',
                    wash: '#f0efec',
                    bull: '#0f7b3f',
                    bear: '#c4314b',
                    'bull-bg': '#dbf3e6',
                    'bear-bg': '#fce4e8',
                    neutral: '#787774',
                },
                fontFamily: {
                    sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Noto Sans', 'Helvetica', 'Arial', 'sans-serif'],
                },
            }
        }
    }
    </script>
    <style>
        /* Animations */
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section-card { animation: fadeSlideIn 0.35s ease-out; }
        .error-message { animation: fadeSlideIn 0.3s ease-out; }

        /* Loading dots */
        .loading-dots::after { content: ''; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* JS-toggled states */
        .loading { display: none; }
        .loading.active { display: block; }
        .results { display: none; }
        .results.active { display: block; }
        .autocomplete-list { display: none; }
        .autocomplete-list.visible { display: block; }
        .section-card.collapsed .section-body { display: none; }
        .section-card.collapsed .chevron { transform: rotate(-90deg); }
    </style>
</head>
<body class="font-sans bg-white text-ink leading-relaxed antialiased">
    <div class="max-w-[900px] mx-auto px-3 py-6 sm:px-5 sm:py-8 lg:px-10 lg:py-[60px]">
        <!-- Header -->
        <div class="mb-6 lg:mb-12">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div>
                    <h1 class="text-[22px] sm:text-[28px] lg:text-[40px] font-bold -tracking-[0.03em] text-ink mb-1 sm:mb-2">Stock Analyzer</h1>
                    <p class="text-sm lg:text-base text-muted">Technical & fundamental analysis</p>
                    <p class="text-xs text-lite mt-1" id="todayDate"></p>
                </div>
                <div class="flex gap-1.5 sm:gap-2">
                    <a href="/" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-edge rounded-md bg-white text-subtle no-underline transition-all duration-150 hover:border-ink hover:text-ink">Dashboard</a>
                    <a href="/groups" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-edge rounded-md bg-white text-subtle no-underline transition-all duration-150 hover:border-ink hover:text-ink">Group Analysis</a>
                    <a href="/analyze" class="text-xs sm:text-[13px] font-medium px-3 sm:px-[18px] py-2 border border-ink rounded-md bg-ink text-white no-underline transition-all duration-150">Individual Analysis</a>
                </div>
            </div>
        </div>

        <!-- Market toggle -->
        <div class="relative mb-6 sm:mb-12">
            <div class="inline-flex bg-wash rounded-md p-0.5 mb-3" id="marketToggle">
                <button class="active font-sans text-[13px] font-medium px-4 py-1.5 border-none rounded bg-white text-ink shadow-sm cursor-pointer transition-all duration-150" data-market="IN">India</button>
                <button class="font-sans text-[13px] font-medium px-4 py-1.5 border-none rounded bg-transparent text-muted cursor-pointer transition-all duration-150 hover:text-subtle" data-market="US">US</button>
            </div>
        </div>

        <!-- Search -->
        <div class="relative mb-6 sm:mb-12">
            <div class="flex gap-2">
                <input
                    type="text"
                    class="flex-1 px-4 sm:px-5 py-3 sm:py-4 text-base sm:text-lg font-sans border border-edge rounded-lg bg-white text-ink outline-none transition-all duration-150 focus:border-ink focus:shadow-[0_0_0_3px_rgba(55,53,47,0.08)] placeholder:text-lite"
                    id="symbolInput"
                    placeholder="Enter stock symbol (e.g. RELIANCE, TCS, INFY)"
                    autocomplete="off"
                    spellcheck="false"
                >
                <button
                    id="analyzeBtn"
                    class="px-5 sm:px-7 py-3 sm:py-4 text-sm sm:text-base font-semibold font-sans bg-ink text-white border-none rounded-lg cursor-pointer transition-all duration-150 hover:bg-[#2c2b27] active:scale-[0.97] whitespace-nowrap"
                >Analyze</button>
            </div>
            <div class="autocomplete-list absolute top-full left-0 right-0 bg-white border border-edge border-t-0 rounded-b-lg shadow-lg z-50 max-h-80 overflow-y-auto" id="autocompleteList"></div>
        </div>

        <!-- Loading -->
        <div class="loading text-center py-8 text-muted text-[15px]" id="loading">
            <span>Fetching data<span class="loading-dots"></span></span>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <div class="mb-6 sm:mb-10 pb-4 sm:pb-6 border-b border-edge" id="stockHeader">
                <h2 class="text-xl sm:text-2xl lg:text-[32px] font-bold -tracking-[0.02em]" id="stockName"></h2>
            </div>
            <div id="technicalLabel"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="technicalSections"></div>
            <div id="fundamentalLabel"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="fundamentalSections"></div>
            <div id="piotroskiLabel"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="piotroskiSections"></div>
            <div id="canslimLabel"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="canslimSections"></div>
        </div>
    </div>

    <script>
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const input = document.getElementById('symbolInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const stockName = document.getElementById('stockName');
        const technicalLabel = document.getElementById('technicalLabel');
        const technicalSections = document.getElementById('technicalSections');
        const fundamentalLabel = document.getElementById('fundamentalLabel');
        const fundamentalSections = document.getElementById('fundamentalSections');
        const piotroskiLabel = document.getElementById('piotroskiLabel');
        const piotroskiSections = document.getElementById('piotroskiSections');
        const canslimLabel = document.getElementById('canslimLabel');
        const canslimSections = document.getElementById('canslimSections');
        const autocompleteList = document.getElementById('autocompleteList');
        const marketToggle = document.getElementById('marketToggle');
        const analyzeBtn = document.getElementById('analyzeBtn');

        let currentSource = null;
        let searchTimeout = null;
        let activeIndex = -1;
        let suggestions = [];
        let selectedMarket = 'IN';

        const placeholders = {
            IN: 'Enter stock symbol (e.g. RELIANCE, TCS, INFY)',
            US: 'Enter stock symbol (e.g. AAPL, MSFT, GOOGL)',
        };

        // Market toggle handler
        marketToggle.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-market]');
            if (!btn || btn.classList.contains('active')) return;
            marketToggle.querySelectorAll('button').forEach(b => {
                b.classList.remove('active', 'bg-white', 'text-ink', 'shadow-sm');
                b.classList.add('bg-transparent', 'text-muted');
            });
            btn.classList.add('active', 'bg-white', 'text-ink', 'shadow-sm');
            btn.classList.remove('bg-transparent', 'text-muted');
            selectedMarket = btn.dataset.market;
            input.placeholder = placeholders[selectedMarket] || placeholders.IN;
            input.value = '';
            hideAutocomplete();
            input.focus();
        });

        // Autocomplete: fetch suggestions as user types
        input.addEventListener('input', () => {
            const query = input.value.trim();
            clearTimeout(searchTimeout);

            if (query.length < 1) {
                hideAutocomplete();
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&market=${selectedMarket}`);
                    suggestions = await res.json();
                    activeIndex = -1;
                    renderAutocomplete(suggestions);
                } catch (_) {
                    hideAutocomplete();
                }
            }, 100);
        });

        // Keyboard navigation in dropdown
        input.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (suggestions.length > 0) {
                    activeIndex = Math.min(activeIndex + 1, suggestions.length - 1);
                    highlightItem();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (suggestions.length > 0) {
                    activeIndex = Math.max(activeIndex - 1, 0);
                    highlightItem();
                }
            } else if (e.key === 'Enter') {
                hideAutocomplete();
                if (activeIndex >= 0 && suggestions[activeIndex]) {
                    input.value = suggestions[activeIndex].symbol;
                }
                const symbol = input.value.trim().toUpperCase();
                if (symbol) {
                    startAnalysis(symbol);
                }
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        });

        // Analyze button click
        analyzeBtn.addEventListener('click', () => {
            hideAutocomplete();
            const symbol = input.value.trim().toUpperCase();
            if (symbol) {
                startAnalysis(symbol);
            }
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                hideAutocomplete();
            }
        });

        function renderAutocomplete(items) {
            if (items.length === 0) {
                hideAutocomplete();
                return;
            }
            autocompleteList.innerHTML = items.map((item, i) => `
                <div class="px-4 sm:px-5 py-3 cursor-pointer flex items-center gap-3 transition-colors hover:bg-tint ${i === activeIndex ? 'bg-tint' : ''} ${i === items.length - 1 ? 'rounded-b-lg' : ''}" data-index="${i}">
                    <span class="font-semibold text-sm text-ink min-w-[110px]">${escapeHtml(item.symbol)}</span>
                    <span class="text-[13px] text-muted whitespace-nowrap overflow-hidden text-ellipsis">${escapeHtml(item.name)}</span>
                </div>
            `).join('');

            autocompleteList.querySelectorAll('[data-index]').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = parseInt(el.dataset.index);
                    input.value = suggestions[idx].symbol;
                    hideAutocomplete();
                    startAnalysis(suggestions[idx].symbol);
                });
            });

            autocompleteList.classList.add('visible');
        }

        function highlightItem() {
            autocompleteList.querySelectorAll('[data-index]').forEach((el, i) => {
                el.classList.toggle('bg-tint', i === activeIndex);
            });
        }

        function hideAutocomplete() {
            autocompleteList.classList.remove('visible');
            suggestions = [];
            activeIndex = -1;
        }

        function startAnalysis(symbol) {
            // Cleanup previous
            if (currentSource) {
                currentSource.close();
            }
            technicalSections.innerHTML = '';
            fundamentalSections.innerHTML = '';
            piotroskiSections.innerHTML = '';
            canslimSections.innerHTML = '';
            technicalLabel.innerHTML = '';
            fundamentalLabel.innerHTML = '';
            piotroskiLabel.innerHTML = '';
            canslimLabel.innerHTML = '';

            stockName.textContent = symbol;
            loading.classList.add('active');
            results.classList.add('active');

            const source = new EventSource(`/api/analyze/${encodeURIComponent(symbol)}?market=${selectedMarket}`);
            currentSource = source;

            const categoryConfig = {
                technical:    { started: false, label: technicalLabel,    sections: technicalSections,    title: 'Technical Analysis' },
                fundamental:  { started: false, label: fundamentalLabel,  sections: fundamentalSections,  title: 'Fundamental Analysis' },
                piotroski:    { started: false, label: piotroskiLabel,    sections: piotroskiSections,    title: 'Piotroski F-Score' },
                canslim:      { started: false, label: canslimLabel,      sections: canslimSections,      title: 'CAN SLIM Analysis' },
            };

            source.addEventListener('section', (e) => {
                loading.classList.remove('active');
                const data = JSON.parse(e.data);

                const cat = categoryConfig[data.category];
                if (cat && !cat.started) {
                    cat.started = true;
                    cat.label.innerHTML = `<div class="text-sm sm:text-base font-bold -tracking-[0.01em] text-ink mt-7 sm:mt-11 mb-2.5 sm:mb-3.5 pb-2.5 border-b-2 border-edge">${cat.title}</div>`;
                }

                const container = cat ? cat.sections : fundamentalSections;
                container.appendChild(createSectionCard(data));
            });

            source.addEventListener('error', (e) => {
                loading.classList.remove('active');
            });

            source.addEventListener('error', (e) => {
                try {
                    if (e.data) {
                        const data = JSON.parse(e.data);
                        showError(data.message);
                    }
                } catch (_) {}
                source.close();
            });

            source.addEventListener('done', () => {
                loading.classList.remove('active');
                source.close();
            });
        }

        function signalIcon(signal) {
            if (signal === 'bullish') return '↑';
            if (signal === 'bearish') return '↓';
            return '—';
        }

        function createSectionCard(data) {
            const card = document.createElement('div');
            const isSummary = data.is_summary;
            card.className = `section-card bg-white border rounded-[10px] overflow-hidden ${isSummary ? 'col-span-1 sm:col-span-2 border-[1.5px] border-ink' : 'border-[#e8e7e4]'}`;

            // Header
            const header = document.createElement('div');
            header.className = 'px-3 sm:px-4 py-2.5 sm:py-3 text-xs sm:text-[13px] font-semibold text-ink bg-[#fafaf9] border-b border-wash cursor-pointer flex items-center gap-1.5 select-none transition-colors hover:bg-wash';
            header.innerHTML = `<span class="chevron text-[9px] text-lite transition-transform duration-200">▼</span> ${escapeHtml(data.section)}`;
            header.addEventListener('click', () => {
                card.classList.toggle('collapsed');
            });

            // Body
            const body = document.createElement('div');
            body.className = 'section-body py-1.5';

            for (const row of data.rows) {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex items-center justify-between px-3 sm:px-4 py-1.5 text-[13px] transition-colors hover:bg-[#fafaf9]';

                if (isSummary) {
                    rowEl.innerHTML = `
                        <span class="text-muted text-xs sm:text-[12.5px] shrink min-w-0">${escapeHtml(row.label)}</span>
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded text-xs sm:text-[13px] font-bold whitespace-nowrap ${row.signal === 'bullish' ? 'bg-bull-bg text-bull' : row.signal === 'bearish' ? 'bg-bear-bg text-bear' : 'bg-wash text-neutral'}">${signalIcon(row.signal)} ${escapeHtml(row.value)}</span>
                    `;
                } else {
                    const valueHtml = row.signal
                        ? `<span class="inline-flex items-center gap-0.5 px-2 py-px rounded text-[11px] sm:text-xs font-semibold leading-relaxed whitespace-nowrap ${row.signal === 'bullish' ? 'bg-bull-bg text-bull' : row.signal === 'bearish' ? 'bg-bear-bg text-bear' : 'bg-wash text-neutral'}">${signalIcon(row.signal)} ${escapeHtml(row.value)}</span>`
                        : `<span class="font-semibold text-ink text-xs sm:text-[13px] text-right shrink-0 ml-3">${escapeHtml(row.value)}</span>`;
                    rowEl.innerHTML = `
                        <span class="text-muted text-xs sm:text-[12.5px] shrink min-w-0">${escapeHtml(row.label)}</span>
                        ${valueHtml}
                    `;
                }

                body.appendChild(rowEl);
            }

            card.appendChild(header);
            card.appendChild(body);
            return card;
        }

        function showError(message) {
            const el = document.createElement('div');
            el.className = 'error-message px-4 sm:px-5 py-3 sm:py-4 bg-bear-bg text-bear rounded-lg text-sm mb-4';
            el.textContent = message;
            results.insertBefore(el, results.firstChild.nextSibling);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Deep link: /?symbol=X&market=Y
        const params = new URLSearchParams(window.location.search);
        const deepSymbol = params.get('symbol');
        const deepMarket = params.get('market');
        if (deepMarket && deepMarket !== selectedMarket) {
            const btn = marketToggle.querySelector(`button[data-market="${deepMarket.toUpperCase()}"]`);
            if (btn) btn.click();
        }
        if (deepSymbol) {
            input.value = deepSymbol.toUpperCase();
            startAnalysis(deepSymbol.toUpperCase());
        }

        // Auto-focus
        input.focus();
    </script>
</body>
</html>

